
#include <assert.h>

#include <stdint.h>
#include <stdio.h>

#include "NTT_params.h"
#include "ring.h"

#include "tools.h"
#include "naive_mult.h"
#include "gen_table.h"
#include "ntt_c.h"

struct compress_profile profile;

int32_t const_buff[8] = {
Qprime, Q, RmodQ, RmodQhi
};

// common buffer
int32_t streamlined_twiddle_table[N << 1];

// ================

static
int32_t streamlined_CT_table[N << 1] = {
-3572223, -1830765815, 3765607, 1929875198, 3761513, 1927777021, -3201494, -1640767044, -2883726, -1477910808, -3145678, -1612161320, -3201430, -1640734244, -601683, -308362795, 3542485, 1815525077, 2682288, 1374673747, 2129892, 1091570561, 3764867, 1929495947, -1005239, -515185417, 557458, 285697463, -1221177, -625853735, -3370349, -1727305304, -4063053, -2082316400, 2663378, 1364982364, -1674615, -858240904, -3524442, -1806278032, -434125, -222489248, 676590, 346752664, -1335936, -684667771, -3227876, -1654287830, 1714295, 878576921, 2453983, 1257667337, 1460718, 748618600, -642628, -329347125, -3585098, -1837364258, 2815639, 1443016191, 2283733, 1170414139, 3602218, 1846138265, 3182878, 1631226336, 2740543, 1404529459, -3586446, -1838055109, -3110818, -1594295555, 2101410, 1076973524, 3704823, 1898723372, 1159875, 594436433, 394148, 202001019, 928749, 475984260, 1095468, 561427818, -3506380, -1797021249, 2071829, 1061813248, -4018989, -2059733581, 3241972, 1661512036, 2156050, 1104976547, 3415069, 1750224323, 1759347, 901666090, -817536, -418987550, -3574466, -1831915353, 3756790, 1925356481, -1935799, -992097815, -1716988, -879957084, -3950053, -2024403852, -2897314, -1484874664, 3192354, 1636082790, 556856, 285388938, 3870317, 1983539117, 2917338, 1495136972, 1853806, 950076368, 3345963, 1714807468, 1858416, 952438995, 3073009, 1574918427, 1277625, 654783359, -2635473, -1350681039, 3852015, 1974159335, 4183372, 2143979939, -3222807, -1651689966, -3121440, -1599739335, -274060, -140455867, 2508980, 1285853323, 2028118, 1039411342, 1937570, 993005454, -3815725, -1955560694, 2811291, 1440787840, -2983781, -1529189038, -1109516, -568627424, 4158088, 2131021878, 1528066, 783134478, 482649, 247357819, 1148858, 588790216, -2962264, -1518161567, -565603, -289871779, 169688, 86965173, 2462444, 1262003603, -3334383, -1708872713, -4166425, -2135294594, -3488383, -1787797779, 1987814, 1018755525, -3197248, -1638590967, 1736313, 889861155, 235407, 120646188, -3250154, -1665705315, 3258457, 1669960606, -2579253, -1321868265, 1787943, 916321552, -2391089, -1225434135, -2254727, -1155548552, 3482206, 1784632064, -4182915, -2143745726, -1300016, -666258756, -2362063, -1210558298, -1317678, -675310538, 2461387, 1261461890, 3035980, 1555941048, 621164, 318346816, 3901472, 1999506068, -1226661, -628664287, 2925816, 1499481951, 3374250, 1729304568, 1356448, 695180180, -2775755, -1422575624, 2683270, 1375177022, -2778788, -1424130038, -3467665, -1777179795, 2312838, 1185330464, -653275, -334803717, -459163, -235321234, 348812, 178766299, -327848, -168022240, 1011223, 518252220, -2354215, -1206536194, -3818627, -1957047970, -1922253, -985155484, -2236726, -1146323031, 1744507, 894060583, 1753, 898413, -1935420, -991903578, -2659525, -1363007700, -1455890, -746144248, 2660408, 1363460238, -1780227, -912367099, -59148, -30313375, 2772600, 1420958686, 1182243, 605900043, 87208, 44694137, 636927, 326425360, -3965306, -2032221021, -3956745, -2027833504, -2296397, -1176904444, -3284915, -1683520342, -3716946, -1904936414, -27812, -14253662, 822541, 421552614, 1009365, 517299994, -2454145, -1257750362, -1979497, -1014493059, 1596822, 818371958, -3956944, -2027935492, -3759465, -1926727420, -1685153, -863641633, -3410568, -1747917558, 2678278, 1372618620, -3768948, -1931587462, -3551006, -1819892093, 635956, 325927722, -250446, -128353682, -2455377, -1258381762, -4146264, -2124962073, -1772588, -908452108, 2192938, 1123881663, -1727088, -885133339, 2387513, 1223601433, -3611750, -1851023419, -268456, -137583815, -3180456, -1629985060, 3747250, 1920467227, 2296099, 1176751719, 1239911, 635454918, -3838479, -1967222129, 3195676, 1637785316, 2642980, 1354528380, 1254190, 642772911, -12417, -6363718, 2998219, 1536588520, 141835, 72690498, -89301, -45766801, 2513018, 1287922800, -1354892, -694382729, 613238, 314284737, -1310261, -671509323, -2218467, -1136965286, -458740, -235104446, -1921994, -985022747, 4040196, 2070602178, -3472069, -1779436847, 2039144, 1045062172, -1879878, -963438279, -818761, -419615363, -2178965, -1116720494, -1623354, -831969619, 2105286, 1078959975, -2374402, -1216882040, -2033807, -1042326957, 586241, 300448763, -1179613, -604552167, 527981, 270590488, -2743411, -1405999311, -1476985, -756955444, 1994046, 1021949428, 2491325, 1276805128, -1393159, -713994583, 507927, 260312805, -1187885, -608791570, -724804, -371462360, -1834526, -940195359, -3033742, -1554794072, -338420, -173440395, 2647994, 1357098057, 3009748, 1542497137, -2612853, -1339088280, 4148469, 2126092136, 749577, 384158533, -4022750, -2061661095, 3980599, 2040058690, 2569011, 1316619236, -1615530, -827959816, 1723229, 883155599, 1665318, 853476187, 2028038, 1039370342, 1163598, 596344473, -3369273, -1726753853, 3994671, 2047270596, -11879, -6087993, -1370517, -702390549, 3020393, 1547952704, 3363542, 1723816713, 214880, 110126092, 545376, 279505433, -770441, -394851342, 3105558, 1591599803, -1103344, -565464272, 508145, 260424530, -553718, -283780712, 860144, 440824168, 3430436, 1758099917, 140244, 71875110, -1514152, -776003547, -2185084, -1119856484, 3123762, 1600929361, 2358373, 1208667171, -2193087, -1123958025, -3014420, -1544891539, -1716814, -879867909, 2926054, 1499603926, -392707, -201262505, -303005, -155290192, 3531229, 1809756372, -3974485, -2036925262, -3773731, -1934038751, 1900052, 973777462, -781875, -400711272, 1054478, 540420426, -731434, -374860238
};

static
int32_t streamlined_CT_inv_table[N << 1] = {
1, 513, 1, 513, 3572223, 1830765815, 1, 513, -3761513, -1927777021, 3572223, 1830765815, -3765607, -1929875198, 1, 513, 3201430, 1640734244, -3761513, -1927777021, 2883726, 1477910808, 3572223, 1830765815, 3145678, 1612161320, -3765607, -1929875198, 3201494, 1640767044, 1, 513, 1221177, 625853735, 3201430, 1640734244, -2129892, -1091570561, -3761513, -1927777021, 1005239, 515185417, 2883726, 1477910808, -3542485, -1815525077, 3572223, 1830765815, -557458, -285697463, 3145678, 1612161320, -2682288, -1374673747, -3765607, -1929875198, -3764867, -1929495947, 3201494, 1640767044, 601683, 308362795, 1, 513, -2283733, -1170414139, 1221177, 625853735, 1335936, 684667771, 3201430, 1640734244, -1460718, -748618600, -2129892, -1091570561, 1674615, 858240904, -3761513, -1927777021, 3585098, 1837364258, 1005239, 515185417, 434125, 222489248, 2883726, 1477910808, -1714295, -878576921, -3542485, -1815525077, 4063053, 2082316400, 3572223, 1830765815, -2815639, -1443016191, -557458, -285697463, -676590, -346752664, 3145678, 1612161320, -2453983, -1257667337, -2682288, -1374673747, -2663378, -1364982364, -3765607, -1929875198, 642628, 329347125, -3764867, -1929495947, 3524442, 1806278032, 3201494, 1640767044, 3227876, 1654287830, 601683, 308362795, 3370349, 1727305304, 1, 513, -1858416, -952438995, -2283733, -1170414139, -2156050, -1104976547, 1221177, 625853735, 3950053, 2024403852, 1335936, 684667771, -1159875, -594436433, 3201430, 1640734244, -3870317, -1983539117, -1460718, -748618600, 3506380, 1797021249, -2129892, -1091570561, 3574466, 1831915353, 1674615, 858240904, 3586446, 1838055109, -3761513, -1927777021, -1853806, -950076368, 3585098, 1837364258, 4018989, 2059733581, 1005239, 515185417, 1935799, 992097815, 434125, 222489248, -2101410, -1076973524, 2883726, 1477910808, -3192354, -1636082790, -1714295, -878576921, -928749, -475984260, -3542485, -1815525077, -1759347, -901666090, 4063053, 2082316400, -3182878, -1631226336, 3572223, 1830765815, -3345963, -1714807468, -2815639, -1443016191, -3241972, -1661512036, -557458, -285697463, 1716988, 879957084, -676590, -346752664, -3704823, -1898723372, 3145678, 1612161320, -556856, -285388938, -2453983, -1257667337, -1095468, -561427818, -2682288, -1374673747, 817536, 418987550, -2663378, -1364982364, -2740543, -1404529459, -3765607, -1929875198, -2917338, -1495136972, 642628, 329347125, -2071829, -1061813248, -3764867, -1929495947, -3756790, -1925356481, 3524442, 1806278032, 3110818, 1594295555, 3201494, 1640767044, 2897314, 1484874664, 3227876, 1654287830, -394148, -202001019, 601683, 308362795, -3415069, -1750224323, 3370349, 1727305304, -3602218, -1846138265, 1, 513, -1744507, -894060583, -1858416, -952438995, -3258457, -1669960606, -2283733, -1170414139, -3374250, -1729304568, -2156050, -1104976547, -4158088, -2131021878, 1221177, 625853735, 459163, 235321234, 3950053, 2024403852, 3334383, 1708872713, 1335936, 684667771, 2362063, 1210558298, -1159875, -594436433, 274060, 140455867, 3201430, 1640734244, 2354215, 1206536194, -3870317, -1983539117, 3197248, 1638590967, -1460718, -748618600, -621164, -318346816, 3506380, 1797021249, 3815725, 1955560694, -2129892, -1091570561, 2778788, 1424130038, 3574466, 1831915353, 2962264, 1518161567, 1674615, 858240904, 2254727, 1155548552, 3586446, 1838055109, -3852015, -1974159335, -3761513, -1927777021, 1922253, 985155484, -1853806, -950076368, -235407, -120646188, 3585098, 1837364258, 1226661, 628664287, 4018989, 2059733581, 2983781, 1529189038, 1005239, 515185417, -2312838, -1185330464, 1935799, 992097815, -169688, -86965173, 434125, 222489248, 4182915, 2143745726, -2101410, -1076973524, 3222807, 1651689966, 2883726, 1477910808, 327848, 168022240, -3192354, -1636082790, 3488383, 1787797779, -1714295, -878576921, -2461387, -1261461890, -928749, -475984260, -2028118, -1039411342, -3542485, -1815525077, 2775755, 1422575624, -1759347, -901666090, -482649, -247357819, 4063053, 2082316400, -1787943, -916321552, -3182878, -1631226336, -1277625, -654783359, 3572223, 1830765815, 2236726, 1146323031, -3345963, -1714807468, 3250154, 1665705315, -2815639, -1443016191, -2925816, -1499481951, -3241972, -1661512036, 1109516, 568627424, -557458, -285697463, 653275, 334803717, 1716988, 879957084, -2462444, -1262003603, -676590, -346752664, 1300016, 666258756, -3704823, -1898723372, 3121440, 1599739335, 3145678, 1612161320, -1011223, -518252220, -556856, -285388938, -1987814, -1018755525, -2453983, -1257667337, -3035980, -1555941048, -1095468, -561427818, -1937570, -993005454, -2682288, -1374673747, -2683270, -1375177022, 817536, 418987550, -1148858, -588790216, -2663378, -1364982364, 2391089, 1225434135, -2740543, -1404529459, 2635473, 1350681039, -3765607, -1929875198, 3818627, 1957047970, -2917338, -1495136972, -1736313, -889861155, 642628, 329347125, -3901472, -1999506068, -2071829, -1061813248, -2811291, -1440787840, -3764867, -1929495947, 3467665, 1777179795, -3756790, -1925356481, 565603, 289871779, 3524442, 1806278032, -3482206, -1784632064, 3110818, 1594295555, -4183372, -2143979939, 3201494, 1640767044, -348812, -178766299, 2897314, 1484874664, 4166425, 2135294594, 3227876, 1654287830, 1317678, 675310538, -394148, -202001019, -2508980, -1285853323, 601683, 308362795, -1356448, -695180180, -3415069, -1750224323, -1528066, -783134478, 3370349, 1727305304, 2579253, 1321868265, -3602218, -1846138265, -3073009, -1574918427
};

static
int32_t last_twist_mont_table[N << 1] = {
16382, 8395782, -1644522, -842818228, -1291704, -661998852, 3608627, 1849422881, 1484049, 760575747, 2003924, 1027011907, 3213716, 1647030824, -2015586, -1032988687, -1932518, -990416301, -1196256, -613081712, 267032, 136854014, 2285286, 1171210052, 3046555, 1561360740, 1029570, 527655065, -1768240, -906223756, -1100550, -564032346, 1266235, 648945979, -2834182, -1452519487, -3606200, -1848179042, -2942135, -1507845446, -3811828, -1953563480, -2908788, -1490755094, 304300, 155953880, -128903, -66062843, 4034765, 2067818788, 456460, 233935945, 2930777, 1502024466, 1177703, 603573291, -2666911, -1366793028, -1617369, -828902304, -2252592, -1154454363, 1126940, 577557232, 1176674, 603045928, -1074967, -550921047, 71096, 36436730, 1544179, 791392398, 2701928, 1384739255, 3687395, 1889791514, -289514, -148376049, -4006320, -2053240713, -3391741, -1738268713, 3397082, 1741005978, -2082410, -1067236015, 3694227, 1893292917, 2139042, 1096259940, 2855247, 1463315308, -323453, -165769801, 3030725, 1553247858, 4165644, 2134894331, 303555, 155572067, -320128, -164065737, -3652572, -1871944712, 2928433, 1500823165, -3698525, -1895495644, -3185999, -1632825850, 2943041, 1508309771, -3942328, -2020444786, -2096158, -1074281871, -3940422, -2019467960, 867824, 444760171, -1945215, -996923519, -2711718, -1389756635, 830280, 425518855, -276802, -141861143, 100235, 51370480, 3399074, 1742026878, -3258440, -1669951893, -1871079, -958928788, 1581316, 810425126, -3345528, -1714584531, -1445654, -740898293, -1372861, -703591850, 1113100, 570464226, 1673850, 857848841, -1079464, -553225762, -4064138, -2082872463, 2521846, 1292447153, 603796, 309445708, -2672019, -1369410880, -116259, -59582787, 305893, 156770293, 167496, 85841772, -1046859, -536515685, 2055067, 1053222716, 761290, 390161451, -3417705, -1751575274, 2469628, 1265685406, -3856547, -1976481987, -3138283, -1608371379, -389020, -199372916, -2156279, -1105093910, 1944480, 996546831, 1454416, 745388822, -821436, -420986301, -602826, -308948583, -172446, -88378649, 788703, 404210625, 1425073, 730350522, -1041361, -533697958, 879039, 450507863, -3341148, -1712339779, 915972, 469436042, 626783, 321226556, -315163, -161521172, -803323, -411703381, -1578061, -808756937, 4124770, 2113946389, -3382322, -1733441471, 4071154, 2086468166, 403894, 206995848, 3724329, 1908720205, -3970566, -2034916773, 1398455, 716708785, -2642882, -1354478155, 275768, 141331218, -2165461, -1109799688, -1368491, -701352223, -3839614, -1967803817, -4022687, -2061628808, 843874, 432485786, 3662432, 1876997966, 1852187, 949246630, -524811, -268965862, 391711, 200752055, 1047178, 536679173, -3379297, -1731891158, -4151501, -2127646038, 2932929, 1503127367, -294725, -151046689, -2419159, -1239820022, 2862208, 1466882824, -4104915, -2103770693, 2741731, 1405138310, 3386239, 1735448935, 3233627, 1657235220, -3597958, -1843955014, 17070, 8748382, -1242950, -637012406, -3112889, -1595356944, 2641904, 1353976930, -3282775, -1682423591, -1311761, -672278073, -1033361, -529597954, 2819973, 1445237368, 2377574, 1218507692, 1368612, 701414235, 158541, 81252330, 2447765, 1254480609, 3017964, 1546707840, -2259509, -1157999329, 3569830, 1829539401, 131113, 67195469, 3394311, 1739585839, -825110, -422869228, 2222515, 1139039888, -1872733, -959776463, -1430472, -733117512, -794398, -407129315, -1874454, -960658477, -3165836, -1622492304, 1312863, 672842849, 2553597, 1308719554, 2229223, 1142477741, 2042594, 1046830298, 3859121, 1977801163, 255574, 130981784, 1931514, 989901751, -4067201, -2084442252, -289157, -148193086, -2677309, -1372122007, 2350535, 1204650193, 1908806, 978263891, -3483979, -1785540727, -255360, -130872109, 3747856, 1920777803, -518949, -265961584, -2715685, -1391789724, -1144116, -586359939, -2041975, -1046513061, -3643993, -1867547971, 968386, 496298239, -2399316, -1229650476, 1824826, 935224105, -854689, -438028478, -3007494, -1541341961, 672351, 344580175, 750940, 384857071, 2137363, 1095399451, -1681557, -861798682, 3938267, 2018363522, -1589698, -814720905, -1449433, -742835032, 75663, 38777320, -1783126, -913852837, -3065391, -1571014198, -914846, -468858966, 1687035, 864606159, -2982141, -1528348538, -1144268, -586437839, 4105895, 2104272943, 1728144, 885674539, -3398031, -1741492341, 3526155, 1807155945, 900767, 461643473, -13828, -7086856, 893967, 458158470, -4177747, -2141097124, -3128905, -1603565150, 3817926, 1956688708, -3568941, -1829083789, -3558813, -1823893184, -3883889, -1990494773, 2048668, 1049943226, -3412190, -1748748834, -3032856, -1554339997, -4093936, -2098143951, -3664286, -1877948142, -303269, -155425492, -173, -88663, -831827, -426311693, 104699, 53658282, 157820, 80882817, 3050122, 1563188829, 3744961, 1919294114, 2225122, 1140375976, 2621046, 1343287196, 1206210, 618183141, -2155369, -1104627534, -2883940, -1478020483, -2148141, -1100923181, -4122115, -2112585700, 1082848, 554960063, -1366638, -700402559, 2260451, 1158482104, -1753196, -898513700, -894975, -458675070, -4011446, -2055867790, 1704391, 873501116, 3835025, 1965451952, -361139, -185083892, 1400514, 717764024, 3285081, 1683605417, 3534748, 1811559861, 800379, 410194580, 2003534, 1026812032, 2888634, 1480426160, -471633, -241712114, 3073666, 1575255139, 2870122, 1470938752, 1976031, 1012716732, -739868, -379182666, 817063, 418745137, 3361238, 1722635912, 2722087, 1395070751, -868519, -445116359, -3576395, -1832903967
};

static
int32_t last_twist_table[N << 1] = {
-32736, -16777214, -1372055, -703178774, 4019714, 2060105144, 3511264, 1799524301, 3659173, 1875327727, -1852791, -949556180, 2900776, 1486648940, -2642025, -1354038942, -1416569, -725992218, 2886683, 1479426272, -2828477, -1449595672, 4157521, 2130731290, 580826, 297673573, -974914, -499643842, -3944563, -2021590224, -2669833, -1368290554, -1861182, -953856571, -96674, -49545466, 3308130, 1695418040, 958010, 490980535, 899302, 460892660, 1128738, 578478708, 569537, 291887956, -3422595, -1754081401, -4184990, -2144809165, 3898594, 1998031092, 1613291, 826812327, 2893192, 1482762137, -2001427, -1025732193, -3753924, -1923887655, 3798447, 1946705712, 3917490, 2007715300, 3482522, 1784794014, -1131019, -579647721, -1267508, -649598392, 1944987, 996806669, 3553106, 1820968344, 3037717, 1556831261, -2082615, -1067341078, -3782654, -1938611792, -594954, -304914179, 329523, 168880678, 3533062, 1810695786, -476046, -243973779, 1715969, 879434846, -223710, -114651471, -1458215, -747335811, -3978303, -2038881989, -924928, -474025996, 2136407, 1094909501, 3022567, 1549066880, 3983976, 2041789404, 2043595, 1047343311, -1452141, -744222883, -2869197, -1470464689, 4167059, 2135619519, -3889043, -1993136200, 3425482, 1755560990, 3969864, 2034556998, -3659686, -1875590640, 3745914, 1919782527, 3707113, 1899896998, -571559, -292924232, -583561, -299075262, 3422587, 1754077301, -1666482, -854072738, 1677045, 859486280, -2284177, -1170641689, 3593719, 1841782524, 188494, 96603256, -3700088, -1896296682, 1699788, 871142077, -2408460, -1234336780, 1165096, 597112198, 2983768, 1529182376, 1168172, 598688650, -1457421, -746928886, -1468480, -752596628, -3294681, -1688525421, -2511702, -1287248349, 2393655, 1226749211, -2546702, -1305185864, -4002827, -2051450549, 3860453, 1978483813, 2397290, 1228612150, -376301, -192854423, -1310103, -671428348, -3476254, -1781581661, 1671232, 856507115, 3141817, 1610182556, 4108340, 2105526007, -3324964, -1704045472, -3085393, -1581265232, 1150368, 589564092, -740339, -379424054, -91254, -46767714, 3743169, 1918375713, -1159554, -594271921, 2882049, 1477051345, 1775252, 909817409, 1100554, 564034396, 1659501, 850494972, -4143846, -2123722847, 3941643, 2020093723, 3888888, 1993056763, 528086, 270644301, -1744623, -894120034, 1136791, 582605874, -625612, -320626418, 2021843, 1036195402, 2807374, 1438780375, -2881109, -1476569594, -1421486, -728512183, 1624598, 832607170, 1745851, 894749384, 359542, 184265429, 3757768, 1925857707, 394154, 202004094, 2911619, 1492205983, 422355, 216457118, -2504801, -1283711584, -3371762, -1728029467, 1269720, 650732043, -1433460, -734648863, 969647, 496944502, -1906912, -977293215, -2329247, -1193740083, -1956600, -1002758337, 46690, 23928645, 454185, 232770007, -1759007, -901491840, -2386530, -1223097645, 1394578, 714721821, 2548863, 1306293377, 732888, 375605413, -2552430, -1308121466, -3448279, -1767244462, -1440932, -738478266, -273317, -140075079, 1500957, 769241104, -405496, -207816873, -2223217, -1139399663, -388498, -199105391, 2533504, 1298421883, -3603138, -1846609766, -862566, -442065444, 1213784, 622064819, -1729890, -886569365, 137651, 70546196, 291696, 149494325, -664339, -340474022, 1586785, 813227991, -591891, -303344391, 3140526, 1609520918, -1566250, -802703795, 2881817, 1476932445, -309096, -158411832, 3566162, 1827659550, -1035359, -530621930, -392601, -201208180, 1649088, 845158305, -2767035, -1418106621, 748978, 383851545, 115162, 59020574, 1831041, 938409295, 2821607, 1446074794, -858901, -440187130, 185954, 95301505, -1089874, -558560891, -493025, -252675523, 2476077, 1268990521, 3366965, 1725571002, 1436105, 736004427, -2203044, -1129060992, -3084753, -1580937232, -35224, -18052315, -2629358, -1347547099, 3297124, 1689777460, -4004274, -2052192137, 1407997, 721599065, -4187015, -2145846978, -2301864, -1179706284, -2296008, -1176705082, -1411591, -723440991, -1516260, -777083898, 3508106, 1797905825, -1594724, -817296732, 1366346, 700252909, 2051663, 1051478165, -56197, -28800987, 1548887, 793805250, 1941813, 995179993, 3357099, 1720514673, 647298, 331740502, 4106917, 2104796719, 3396579, 1740748190, -1255364, -643374587, 1237463, 634200317, 3954274, 2026567116, -968209, -496207527, -2223538, -1139564176, -527136, -270157425, 1032312, 529060341, 904125, 463364449, 679363, 348173828, 750944, 384859121, -3317318, -1700126893, -279168, -143073719, -4106707, -2104689094, -642945, -329509587, 3647242, 1869213085, 3802669, 1948869489, -342035, -175293084, -3819906, -1957703458, -3238655, -1659812072, -3429548, -1757644816, -2932473, -1502893666, -1388051, -711376731, 3063582, 1570087085, 1856626, 951521619, 3089336, 1583286021, 30446, 15603588, 2471595, 1266693494, 1822824, 934198079, 1387418, 711052318, 3242048, 1661550986, -3798739, -1946855362, 394624, 202244969, 3088502, 1582858596, 1784931, 914777901, -802125, -411089405, 3116503, 1597209120, 929217, 476224110, 708061, 362881565, -1500709, -769114004, -2568046, -1316124673, -3013252, -1544292938, -3955287, -2027086279, -2497737, -1280091281, 1141142, 584835763, -2714738, -1391304386, -4050729, -2076000345, -3147955, -1613328284, -1746720, -895194747, 936004, 479702450, 3743755, 1918676038, 59503, 30495313, 3011821, 1543559550, -3555059, -1821969258, 1522988, 780532001, -1724933, -884028900, -2864572, -1468094375, 1360841, 697431594, -1892347, -969828647, -503044, -257810265, -1276711, -654314933
};

// ================

// reduce a to (-Q/2, Q/2)
static
int32_t freeze_32(int32_t a){
    int32_t t;

    t = (a + (1 << 22)) >> 23;
    a -= t * Q;

    if(a >= Q / 2){
        a -= Q;
    }
    if(a <= -Q / 2){
        a += Q;
    }

    return a;

}

// we assume -Q / 2 < a < Q / 2
static int32_t gethi(int32_t a){

    int32_t lo, hi;

    int32_t bp_lo, bp_hi;
    int32_t a_lo, a_hi;

    // below we compute lo = a R mod^+- Q
    lo = a * RmodQ;

    bp_lo = (int32_t)(uint16_t)RmodQhi;
    bp_hi = (int32_t)(int16_t)(RmodQhi >> 16);

    a_lo = (int32_t)(uint16_t)a;
    a_hi = (int32_t)(int16_t)(a >> 16);

    hi = a_hi * bp_hi;
    hi += ((a_lo * bp_hi) >> 16);
    hi += ((a_hi * bp_lo) >> 16);

    lo -= hi * Q;

    lo = freeze_32(lo);

    // return (a R mod^+- Q) * Qprime mod^+- R
    // we reduce mod^+- R by typing
    return lo * Qprime;

}

static
int32_t Barrett_mul_approx(int32_t a, int32_t b, int32_t bp, int32_t q){

    int32_t lo, hi;

    int32_t bp_lo, bp_hi;
    int32_t a_lo, a_hi;

    lo = a * b;

    bp_lo = (int32_t)(uint16_t)bp;
    bp_hi = (int32_t)(int16_t)(bp >> 16);

    a_lo = (int32_t)(uint16_t)a;
    a_hi = (int32_t)(int16_t)(a >> 16);

    hi = a_hi * bp_hi;
    hi += ((a_lo * bp_hi) >> 16);
    hi += ((a_hi * bp_lo) >> 16);

    return lo - hi * q;

}

static
int16_t approx_high_byte(int16_t a, uint16_t b){

    int16_t t;

    int16_t a_lo, a_hi;
    int16_t b_lo, b_hi;

    a_lo = (int16_t)(uint8_t)a;
    a_hi = (int16_t)(int8_t)(a >> 8);

    b_lo = (int16_t)(uint8_t)b;
    b_hi = (int16_t)(uint8_t)(b >> 8);

    t = a_hi * b_hi;
    t += ((a_lo * b_hi) >> 8);
    t += ((a_hi * b_lo) >> 8);

    return t;

}

static
int32_t Barrett_mul_approx_byte(int32_t a, int32_t b, int32_t bp, int32_t q){

    int32_t lo, hi;

    int32_t bp_lo, bp_hi;
    int32_t a_lo, a_hi;

    lo = a * b;

    bp_lo = (int32_t)(uint16_t)bp;
    bp_hi = (int32_t)(int16_t)(bp >> 16);

    a_lo = (int32_t)(uint16_t)a;
    a_hi = (int32_t)(int16_t)(a >> 16);

    hi = a_hi * bp_hi;
    hi += (int32_t)approx_high_byte((int16_t)a_hi, (uint16_t)bp_lo);
    hi += (int32_t)approx_high_byte((int16_t)bp_hi, (uint16_t)a_lo);

    return lo - hi * q;

}

void memberZ_approx(void *des, void *src){
    memmove(des, src, sizeof(int32_t));
}

void addZ_approx(void *des, void *src1, void *src2){
    *(int32_t*)des = (*(int32_t*)src1) + (*(int32_t*)src2);
}

void subZ_approx(void *des, void *src1, void *src2){
    *(int32_t*)des = (*(int32_t*)src1) - (*(int32_t*)src2);
}

void mulZ_approx(void *des, void *src1, void *src2){
    int32_t a, b, c;
    a = *(int32_t*)src1;
    b = *(int32_t*)src2;
    // c = Barrett_mul_approx(a, b, gethi(b), Q);
    c = Barrett_mul_approx_byte(a, b, gethi(b), Q);
    *(int32_t*)des = c;
}

void expZ_approx(void *des, void *src, size_t e){
    return;
}

struct commutative_ring coeff_ring_approx = {
    .sizeZ = sizeof(int32_t),
    .memberZ = memberZ_approx,
    .addZ = addZ_approx,
    .subZ = subZ_approx,
    .mulZ = mulZ_approx,
    .expZ = expZ_approx
};

// ================

int main(void){

    int32_t poly1[N], poly2[N];
    int32_t ref[N], res[N];

    int32_t poly2_extended[N << 1];

    int32_t scale, omega, zeta, twiddle, t;

    for(size_t i = 0; i < N; i++){
        t = rand() % Q;
        coeff_ring.memberZ(poly1 + i, &t);
        t = rand() % Q;
        coeff_ring.memberZ(poly2 + i, &t);
    }

    twiddle = -1;
    naive_mulR(ref, poly1, poly2, N, &twiddle, coeff_ring);

    printf("\n============ test FNT 257 started ============\n");

// ================

    profile.array_n = N;
    profile.ntt_n = N;
    profile.log_ntt_n = LOGNTT_N;
    profile.compressed_layers = 8;

    for(size_t i = 0; i < profile.compressed_layers; i++){
        profile.merged_layers[i] = 1;
    }

    scale = 1;
    zeta = omegaQ;
    coeff_ring.expZ(&omega, &zeta, 2);
    gen_streamlined_DWT_table(streamlined_twiddle_table,
            &scale, &omega, &zeta,
            profile, 0,
            coeff_ring
        );

    // Cooley--Tukey FFT for x^256 + 1
    compressed_CT_NTT(poly1, 0, 7, streamlined_twiddle_table, profile, coeff_ring_approx);
    // equivalently:
    compressed_CT_NTT(poly2, 0, 0, streamlined_twiddle_table, profile, coeff_ring_approx);
    compressed_CT_NTT(poly2, 1, 1, streamlined_twiddle_table, profile, coeff_ring_approx);
    compressed_CT_NTT(poly2, 2, 2, streamlined_twiddle_table, profile, coeff_ring_approx);
    compressed_CT_NTT(poly2, 3, 3, streamlined_twiddle_table, profile, coeff_ring_approx);
    compressed_CT_NTT(poly2, 4, 4, streamlined_twiddle_table, profile, coeff_ring_approx);
    compressed_CT_NTT(poly2, 5, 5, streamlined_twiddle_table, profile, coeff_ring_approx);
    compressed_CT_NTT(poly2, 6, 6, streamlined_twiddle_table, profile, coeff_ring_approx);
    compressed_CT_NTT(poly2, 7, 7, streamlined_twiddle_table, profile, coeff_ring_approx);

// ================
// Base multiplication

    for(size_t i = 0; i < N; i++){
        poly2_extended[2 * i + 0] = freeze_32(poly2[i]);
        poly2_extended[2 * i + 1] = gethi(poly2_extended[2 * i + 0]);
    }

    for(size_t i = 0; i < N; i++){
        res[i] = Barrett_mul_approx(poly1[i], poly2_extended[2 * i + 0], poly2_extended[2 * i + 1], Q);
    }

// ================

    scale = 1;
    omega = omegainvQ;
    coeff_ring.expZ(&omega, &omega, 2);
    gen_streamlined_inv_CT_table(streamlined_twiddle_table,
            &scale, &omega,
            profile, 0,
            coeff_ring
        );

    // inverse of the Cooley--Tukey FFT for x^256 - 1
    compressed_CT_iNTT(res, 0, 7, streamlined_twiddle_table, profile, coeff_ring_approx);

    scale = 1;
    t = INV256;
    coeff_ring.mulZ(&scale, &scale, &t);
    omega = omegainvQ;
    gen_twist_table(streamlined_twiddle_table,
            &scale, &omega,
            profile,
            coeff_ring
        );
    // twist x^256 - 1 back to x^256 + 1
    point_mul(res, res, streamlined_twiddle_table, N, 1, coeff_ring);

// ================

    scale = 1;
    for(size_t i = 0; i < N; i++){
        coeff_ring.mulZ(ref + i, ref + i, &scale);
    }

    scale = 1;
    for(size_t i = 0; i < N; i++){
        coeff_ring.mulZ(res + i, res + i, &scale);
    }

    for(size_t i = 0; i < N; i++){
        if(ref[i] != res[i]){
            printf("%4zu: %12d, %12d\n", i, ref[i], res[i]);
        }
    }

    printf("Test finished!\n");
}













